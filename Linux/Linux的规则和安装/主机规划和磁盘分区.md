# 主机规划和磁盘分区

## 1、Linux与硬件的搭配

### 1.1、各个硬件设备在Linux中的文件名

在Linux系统中，每个设备都被当做一个文件来对待。

在Linux中，几乎所有的硬件设备都会在`/dev`这个目录下，下面是几个常见的设备与其在Linux中的文件名。

|设备|设备在Linux内的文件名|
|-|-|
|IDE硬盘|`/dev/hd[a-d]`|
|SCSI/SATA/USB硬盘|`/dev/sd[a-p]`|
|U盘|`/dev/sd[a-p]`|
|鼠标|`USB：/dev/usb/mouse[0-15]`|

## 2、磁盘分区

一块磁盘可以被分为多个分区，在Windows下，一块磁盘可以分为C盘，D盘，E盘这些分区。Linux的设备都是以文件的类型存在，不同的分区就会对应不同的文件名。

### 2.1、磁盘的连接方式和设备文件名的关系

个人计算机的常见磁盘接口有两种，分别是`IDE`与`SATA`接口，目前的主流接口是`SATA`接口，老一点的主机大部分还是`IDE`接口。


`SATA/USB`接口的磁盘，没有一定的顺序，是根据Linux内核检测到的磁盘顺序。假设一个主板上有6个`SATA`的插槽，两个`SATA`磁盘分别插在接口1和接口5，`USB`磁盘插在最后一个接口，Linux的设备文件名为`/dev/sda`，`/dev/sdb`，`dev/sdc`而与接口代号无关。


### 2.2、磁盘的组成

![磁盘的组成](https://pic1.zhimg.com/v2-3d04e6683158dc4f020e7bf7fe8932c4_r.jpg)

[参考链接](https://zhuanlan.zhihu.com/p/163490198)

整块磁盘的第一个扇区最重要，主要记录了以下的两个重要信息：
1. 主引导分区(`MBR`)：可以安装引导加载程序的地方，有446bytes
2. 分区表(`partition table`)：记录整块硬盘分区的状态，有64bytes

当系统开机的时候会去主动读取这个区块的内容，这样系统才会知道程序放在哪里且如何开机。如果安装多重引导的系统，`MBR`区块的管理就十分重要。

### 2.3、磁盘分区表（partition table）

在分区表的64bytes中，总共分为4组记录区，每组记录区记录了该区段的起始与结束的柱面号码。

![Linux磁盘分区](https://images2018.cnblogs.com/blog/1430251/201809/1430251-20180912141038215-1775782998.png)

[参考链接](https://www.cnblogs.com/liang-io/p/9635158.html)

假设硬盘的设备文件名为`/dev/sda`时，那么四个分区在Linux系统中的设备文件名如下所示
- `/dev/sda1`
- `/dev/sda2`
- `/dev/sda3`
- `/dev/sda4`

这四个分区被称为主或者扩展分区。

当操作系统为Windows时，第1到第4个的分区就是`C`，`D`，`E`，`F`。

分区的意义在于：
1. 数据的安全性：例如在Windows下，重装系统备份C盘，不会影响到D盘
2. 系统的性能考虑：分区将数据集中在柱面的某个区段，有助于数据读取的速度和性能。

在64bytes的分区表中，假设仅用到两个，`P1`为主分区，`P2`为扩展分区。扩展分区使用的是额外的扇区来记录分区信息，扩展分区本身不能拿来格式化，可以通过扩展分区所指向的那个区块继续作分区的记录。扩展分区切分出来的分区叫做逻辑分区。

- `P1`：`/dev/hda1`
- `P2`：`/dev/hda2`
- `L1`：`/dev/hda5`
- `L2`：`/dev/hda6`
- `L3`：`/dev/hda7`
- `L4`：`/dev/hda8`

因为前面四个号码都是保留给主分区或者扩展分区用的，所以逻辑分区的设备名称号码就由5开始。

关于主分区、扩展分区、逻辑分区的特性
- 主分区和扩展分区最多可以有4个（硬盘的限制）
- 扩展分区最多只可以有1个（操作系统的限制）
- 逻辑分区是由扩展分区持续切割出来的分区
- 能够被格式化后作为数据访问的分区为主分区与逻辑分区。扩展分区无法格式化
- 逻辑分区的数量依操作系统而不同，在Linux系统中，`IDE`硬盘最多有59个逻辑分区（5-63号），`SATA`硬盘则有11个逻辑分区（5-15号）


假设在Windows系统下，如果要将D盘和E盘整合成一个新的分区，有两种情况
1. D盘和E盘同属于扩展分区中的逻辑分区，则可以将两个分区删除，再重新创建一个新的分区，就可以在不影响其他分区的情况下，将两个分区的容量整合成一个
2. D盘和E盘分别为主分区和逻辑分区，则两者不能够整合在一起，除非将扩展分区破坏掉再重新分区。但是这样会影响到所有的逻辑分区。因为如果扩展分区被破坏，所有的逻辑分区都会被删除。

### 2.4、开机流程和主引导分区（MBR）

操作系统会控制所有的硬件并提供内核功能，因此计算机可以识别硬盘内的文件系统，并且进一步读取硬盘中的软件文件与执行各项软件达成目的。

操作系统也是软件，开机时是如何读取硬盘中的操作系统文件。

`BIOS`是在开机的时候计算机系统会主动执行的第一个程序。是写到硬件上的一个软件程序。
1. `BIOS`会首先分析计算机有哪些存储设备，以硬盘为例，`BIOS`会依据用户的设置去取得能够开机的硬盘，并到该硬盘里面去读取第一个扇区的`MBR`位置。`MBR`这个446bytes的硬盘容量里面会放置最基本的引导加载程序。`BIOS`的工作就完成了，接下来就是`MBR`的引导加载程序（`boot loader`）的功能了。

2. `MBR`的引导加载程序的目的是加载内核文件，由于引导加载程序是操作系统在安装的时候提供的。所以它会识别硬盘内的文件系统格式，因此就能够读取内核文件，接下来就是内核文件的工作。`MBR`引导加载程序的工作也完成。其主要包括以下内容：
      - 提供菜单：用户可以选择不同的开机选项，也是多重引导的重要功能。
      - 载入内核文件：直接指向可开机的程序区段来开始操作系统。
      - 转交其他loader：将引导加载功能转交给其他loader负责。
  
    其中第三点，假设只有一块硬盘，其中第一、第二分区分别安装了Windows和Linux，假设`MBR`中安装的是可以同时识别Windows/Linux操作系统的引导加载程序。则`MBR`的引导加载程序就会提供两个菜单，菜单1可以直接加载Windows的内核文件来开机，菜单2则将引导加载工作交给第二个分区的启动扇区，当选择菜单2时，整个引导加载工作就会交给第二分区的引导加载程序了。使用Linux的内核文件来开机。这就是多重引导的工作情况。

3. 内核文件开始执行操作系统的功能。

- 每个分区都有自己的启动扇区
- 实际的可开机的内核文件是放置到各个分区内的
- loader只会认识自己的系统分区内的开机内核文件，以及其他loader而已
- loader可以直接指向或者间接将管理权转交给另一个管理程序。

在安装多系统时，最好先安装Windows再安装Linux，因为Linux系统安装时，可以选择将引导加载程序安装在`MBR`或者个别分区的启动扇区，而且Linux的loader可以手动设置菜单，可以在Linux的boot loader中加入Windows的开机选项。

而Windows在安装的时候，它的安装程序会主动覆盖掉`MBR`以及自己所在分区的启动扇区，没有选择的机会。而且没有选择菜单的机会。

如果先安装了Linux，后安装了Windows，则`MBR`的引导加载程序就只会有Windows的选项，而不会有Linux的选项，因为原本在`MBR`内的Linux引导加载程序被覆盖。也无需重新安装Linux，只需要想办法处理`MBR`即可。

### 2.5、Linux安装模式下，磁盘分区的选择

整个Linux系统最重要的地方就是目录树结构，根目录为`/`。

目录树的架构和磁盘内的数据，这个时候就牵扯到挂载。

> 所谓的挂载，就是利用一个目录作为进入点，将磁盘分区的数据放置在该目录下，也即进入该目录就可以读取该分区的意思，这个操作称为挂载。进入的那个目录点，称为挂载点。

初次安装Linux，建议直接以一个最大的分区`/`来安装系统。

## 3、安装Linux前的规划

### 3.1、合适的distribution

### 3.2、主机的服务规划与硬件的关系

- Windows和Linux共存的环境
- NAT（达到路由器的功能）：Linux可以作为NAT路由器的功能，要求网卡有较好的配置
- SAMBA（加入Windows网络上的邻居）：Windows系统之间可以通过网络邻居来传输数据。Linux系统上使用SAMBA这个软件来实现加入Windows邻居的功能。对于系统的网卡和硬盘大小速度就比较重要。
- Mail（邮件服务器）：Linux可以假设邮件服务器，对于网卡和硬盘容量要求也比较大。
- Web（WWW服务器）：如果要作为WWW服务器，则通常需要提升RAM。
- DHCP：对于硬件要求不是很高
- Proxy：对于网卡，硬盘容量和速度要求很高
- FTP：对于硬盘容量，网卡要求高。

