# 嵌入式设备的加密

在一些商业应用的嵌入式设备中，经常会存在硬件平台一致，但是软件功能不同的情况。衍生出下面两个问题：

## 方案(设备型号)不同

> A 型号的设备有一个基线的逻辑 A，但同时应用在场景 1，有自己的一套软件逻辑 A-1 和设备型号 A-mod1，应用在场景 2，有自己的一套软件逻辑 A-2 和设备型号 A-mod2，但是方案设备 A-mod1 和 A-mod2 与基线设备 A 其内部的硬件结构是完全一样的。

假设我在本地开发调试时，仅有设备 A，但是我却需要开发设备 A-mod1 的程序并验证功能。

软件上可以通过不同的宏来控制不同的逻辑 A-1 与 A，但是由于设备 A 的升级校验，无法从 Web 中直接将 A-1 的固件直接升级到设备 A 中。

这时有两种方法：
1. 通过串口强刷升级，绕过升级时 A 设备中基线程序的软件校验
2. 通过加密狗将设备 A 加密成 A-mod1，然后再从 Web 进行升级

## 语言不同


## 加密狗是什么

> 加密狗是一个硬件设备，用于对设备的核心功能、软件授权、配置参数（如设备型号、语言设置等）进行加密保护。



### 加密狗的组成


加密狗由硬件部分和软件部分组成，下面分别来介绍各个部分的组成

|硬件组成|说明|
|-|-|
|安全芯片|核心组件，主要用于<li>密钥存储：存储私钥、证书、设备唯一标识<li>加密运算：硬件加速执行加密算法|
|接口|<li>USB 加密狗<li>NFC/RFID 加密狗（门禁卡形态）等|
|存储单元|<li>OTP(一次性可编程存储器)：用于存储根密钥<li>EEPROM/Flash：可擦写存储，保存配置数据或动态密钥<li>安全存储区：受硬件保护的存储区域|
|加密引擎|硬件加速模块 <li>对称加密，如 AES，DES 等<li>非对称加密：RSA 等 <br>随机数生成器，生成真随即数，用于密钥的生成|


|软件组成|说明|
|-|-|
|固件|<li>芯片初始化：启动时配置安全芯片的时钟、接口、加密引擎<li>协议栈: 实现通信协议（如 USB 协议栈）<li>安全逻辑：定义密钥使用策略|
|驱动程序|在主机（如 PC 或 嵌入式系统）中实现硬件与操作系统的通信<li>通用驱动：如 USB HID/CCID 驱动<li>专用驱动: 厂商私有协议驱动|
|上层软件工具|加密狗管理软件<li>密钥管理:生成、导入、绑定密钥到加密狗<br>开发库 <li>标准化加密接口 PKCS#1<li>厂商专有 SDK|

### 加密狗的作用

加密狗的作用类似于一个硬件密钥，只有在插入到或者连接到指定设备的时候，才能解密或者启用设备的某些功能或者配置信息。

|作用|说明|
|-|-|
|软件授权和版权保护|<li>加密狗通过硬件设备提供唯一的标识符，确保软件只能在授权的设备上运行，防止软件被非法复制或盗版<li>软件通常需要加密狗中的密钥或标识符进行激活，未插入加密狗时软件无法运行或仅能运行有限的功能|
|控制设备功能|<li>加密狗可以控制软件功能的启用或禁用。例如，只有在插入特定的加密狗时，高级功能或模块才能被启用<li>加密狗可以绑定设备的型号信息，确保软件在特定设备上运行，防止跨设备使用|
|加密与数据保护|<li>加密狗可以对设备中的敏感数据、软件代码、配置信息等进行加密存储，防止数据被篡改或窃取<li>加密狗内部存储加密密钥，用于解密和验证设备中的关键信息（如设备型号、语言、内核等）。|

### 加密狗的分类

|分类|场景|
|-|-|
|USB 加密狗|即插即用, 适用 PC 或者嵌入式主机|
|嵌入式安全芯片|直接集成到设备 PCB, 无需外部接口|
|智能卡|适用于高安全场景, 如金融, 政府|

## USB 加密狗加密的流程

### 准备

- 加密狗(U盘)
- 加密服务器(PC)
- tftp服务器软件: 通过 tftp 向嵌入式设备传输加密后的固件
- MicroDog 驱动软件:
- 加密软件(ProductInfoConfig.exe): 与加密狗交互,完成固件加密和密钥管理
- 嵌入式设备: 要求支持 U-Boot, 且已集成加密/解密功能, 网络接口已经配置, 可以与 tftp 服务器通信

一般来说，加密狗、加密狗驱动、加密软件三者是配套的。

### 加密过程原理


|步骤|说明|注意点|
|-|-|-|
|安装加密狗驱动|安装 MicroDog 加密狗驱动。主要目的就是为了让电脑能够识别加密狗硬件。|<li>应该使用厂商提供的官方驱动（避免产生兼容性问题）<li>安装后可以通过设备管理器查看加密狗的识别状态。|
|插入 USB 加密狗|建立物理连接||
|运行加密软件|加密软件会通过驱动检测加密狗是否存在，若加密狗和当前加密软件不匹配, 可能会出现报错提示。 并且进入加密软件之后页面参数全部置灰不可编辑。|加密狗软件需要和加密狗匹配|
|加密狗软件读取参数|加密狗软件通过加密狗内含的 API 接口`ReadData()`读取加密狗内部的加密参数，并将这些参数输出显示在软件上||
|修改并绑定加密狗参数|在软件上配置新的加密参数，如设备型号、语言等。修改完成后点击保存参数，参数经加密狗加密之后保存||
|电脑端启用 TFTP 服务器|为嵌入式设备提供加密后的配置文件或者固件|确保网络正常，且 UDP 69端口是通的|
|Uboot 中设置网络参数|在嵌入式设备的 Uboot 中，设置网络参数<br>`setenv ipaddr`<br>`setenv serverip`<br>`saveenv` ||
|在 Uboot 中运行 `run sec`命令|`run sec`将加密好的固件传输到嵌入式设备中，并解密验证，验证通过后显示加密成功|<li>需要注意 Uboot 需要集成机密狗驱动。<li>`sec`是 Uboot 中预定义的脚本，可能包含以下操作<br>`setenv sec 'tftp 0x80000000 encrypted_firmware.bin; verify_signature 0x80000000; bootm 0x80000000'` <br>包括以下步骤<li>从 TFTP 服务器下载固件到内存地址 0x80000000。<li>调用 verify_signature 验证签名。<li>验证通过后启动固件（公钥已经烧录在嵌入式设备的安全存储区域）。|


整个过程中加密狗作为一个签名和加密工具，加密后的固件可以被设备中的公钥进行验证。假设一些第三方对固件进行非法加密，公钥验证不通过，在嵌入式设备中验证失败是会直接拒绝加密的。











