# 嵌入式设备的加密

在一些商业应用的嵌入式设备中，经常会存在硬件平台一致，但是软件功能不同的情况。比如：
> A 型号的设备应用在场景 1，有自己的一套软件逻辑 A'，B 型号的设备应用在场景 2，有自己的一套软件逻辑 B',但是 A 和 B 的硬件结构是一样的。

假设我在本地开发调试时，仅有设备 A，但是我却需要开发设备 B 的程序并验证功能。

软件上可以通过不同的宏来控制不同的逻辑 A' 与 B'，但是由于设备 A 的升级校验


## 加密狗是什么

> 加密狗是一个硬件设备，用于对设备的核心功能、软件授权、配置参数（如设备型号、语言设置等）进行加密保护。



### 加密狗的组成


加密狗由硬件部分和软件部分组成，下面分别来介绍各个部分的组成

|硬件组成|说明|
|-|-|
|安全芯片|核心组件，主要用于<li>密钥存储：存储私钥、证书、设备唯一标识<li>加密运算：硬件加速执行加密算法|
|接口|<li>USB 加密狗<li>NFC/RFID 加密狗（门禁卡形态）等|
|存储单元|<li>OTP(一次性可编程存储器)：用于存储根密钥<li>EEPROM/Flash：可擦写存储，保存配置数据或动态密钥<li>安全存储区：受硬件保护的存储区域|
|加密引擎|硬件加速模块 <li>对称加密，如 AES，DES 等<li>非对称加密：RSA 等 <br>随机数生成器，生成真随即数，用于密钥的生成|


|软件组成|说明|
|-|-|
|固件|<li>芯片初始化：启动时配置安全芯片的时钟、接口、加密引擎<li>协议栈: 实现通信协议（如 USB 协议栈）<li>安全逻辑：定义密钥使用策略|
|驱动程序|在主机（如 PC 或 嵌入式系统）中实现硬件与操作系统的通信<li>通用驱动：如 USB HID/CCID 驱动<li>专用驱动: 厂商私有协议驱动|
|上层软件工具|加密狗管理软件<li>密钥管理:生成、导入、绑定密钥到加密狗<br>开发库 <li>标准化加密接口 PKCS#1<li>厂商专有 SDK|

### 加密狗的作用

加密狗的作用类似于一个硬件密钥，只有在插入到或者连接到指定设备的时候，才能解密或者启用设备的某些功能或者配置信息。

|作用|说明|
|-|-|
|软件授权和版权保护|<li>加密狗通过硬件设备提供唯一的标识符，确保软件只能在授权的设备上运行，防止软件被非法复制或盗版<li>软件通常需要加密狗中的密钥或标识符进行激活，未插入加密狗时软件无法运行或仅能运行有限的功能|
|控制设备功能|<li>加密狗可以控制软件功能的启用或禁用。例如，只有在插入特定的加密狗时，高级功能或模块才能被启用<li>加密狗可以绑定设备的型号信息，确保软件在特定设备上运行，防止跨设备使用|
|加密与数据保护|<li>加密狗可以对设备中的敏感数据、软件代码、配置信息等进行加密存储，防止数据被篡改或窃取<li>加密狗内部存储加密密钥，用于解密和验证设备中的关键信息（如设备型号、语言、内核等）。|

### 加密狗的分类

|分类|场景|
|-|-|
|USB 加密狗|即插即用, 适用 PC 或者嵌入式主机|
|嵌入式安全芯片|直接集成到设备 PCB, 无需外部接口|
|智能卡|适用于高安全场景, 如金融, 政府|

## USB 加密狗加密的流程

### 准备

- 加密狗(U盘)
- 加密服务器(PC)
- tftp服务器软件: 通过 tftp 向嵌入式设备传输加密后的固件
- MicroDog 驱动软件:
- 加密软件(ProductInfoConfig.exe): 与加密狗交互,完成固件加密和密钥管理
- 嵌入式设备: 要求支持 U-Boot, 且已集成加密/解密功能, 网络接口已经配置, 可以与 tftp 服务器通信

一般来说，加密狗、加密狗驱动、加密软件三者是配套的。

### 加密服务器的配置


#### 安装加密狗驱动

在个人电脑上，首先需要安装 MicroDog 加密狗驱动，根据界面提示安装驱动

若不安装加密狗驱动, 插入加密狗之后加密软件也会报错提示"找不到加密狗"

驱动安装好之后, 运行加密软件, 加密软件会通过驱动检测加密狗是否存在, 若加密狗和当前加密软件不匹配, 可能会出现报错提示. 并且进入加密软件之后页面参数全部置灰不可编辑. 

#### 加密信息设置

加密狗厂商提供软件开发包（SDK），内含API供软件调用加密狗功能。

当在加密软件上操作读取和保存时, 会调用 WriteData() 或 ReadData() 接口，向加密狗写入参数（如设备序列号）或读取密钥。

##### 参数保存

在软件上手动输入设备信息(序列号, IP, 语言等), 点击保存参数

软件调用 API 将参数写入加密狗的安全存储区，同时触发加密狗生成 MAC 地址。

软件点击“GEN”生成 MAC 地址时，软件调用加密狗的加密算法生成唯一标识，而非本地计算。

### 设备网络信息设置

### 开始加密

#### 设备与加密服务器通过 tftp 建立连接

在设备 U-Boot 界面运行 run sec 命令, tftp 会接收到设备信息

run sec 可能会触发以下动作

1. 设备端通过预配置的 serverip（加密服务器 IP）向服务器发起 TFTP 请求。
2. 服务器响应请求并传输加密数据文件（如 secure_info.bin）。
3. 设备接收文件后，利用加密狗生成的密钥完成合法性验证与参数固化。


run sec 实际调用 Uboot 预定义的脚本命令（可能存储在环境变量 sec 中），其内部可能包含以下操作：

    tftp ${loadaddr} secure_info.bin  # 从服务器下载加密文件到内存地址 ${loadaddr}
    sf probe 0:0                      # 初始化 Flash 存储
    sf erase 0x100000 0x10000         # 擦除指定 Flash 区域
    sf write ${loadaddr} 0x100000 ${filesize}  # 将加密数据写入 Flash

#### 执行加密

点击加密软件上的"保存参数" 按钮, 进行加密, 加密软件状态处显示 "设备保存数据成功！ ", 且设备的 U-Boot 界面会实时打印出加密信息.

获取加密所需的参数文件（如 MAC 地址、设备序列号绑定信息等）


