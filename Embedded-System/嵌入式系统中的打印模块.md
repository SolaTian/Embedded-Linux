# 嵌入式系统中的打印模块

在一些大型的嵌入式项目开发中，由于项目代码量十分巨大，且包含众多模块。在众多模块中，可以分成主模块和子模块。在实际开发和调试的过程中往往需要查看某几个子模块的打印。

比如嵌入式系统中，网络流量主模块，包含数据上传子模块和数据接收子模块。在实际的调试中，就需要精确到具体的子模块。


## 写一个自己的打印宏

打印一般包括几个常规等级。

- `ERROR`: 默认打开
- `WARN`：默认打开
- `INFO`：默认关闭
- `DBG`：默认关闭

希望能够通过自己设定打印等级，然后在程序中显示不同级别的打印

```c
//logger.h
#ifndef LOGGER_H
#define LOGGER_H

#include <stdio.h>
#include <stdarg.h>
#include <time.h>
#include <string.h>

// 日志级别
typedef enum {
    LOG_LEVEL_ERR  = 0,  // 错误（红色）
    LOG_LEVEL_WARN = 1,  // 警告（黄色）
    LOG_LEVEL_INFO = 2,  // 信息（绿色）
    LOG_LEVEL_DBG  = 3   // 调试（蓝色）
} LogLevel;

// 初始化日志系统（默认输出到stderr）
void logger_init(FILE *output);

// 核心打印函数
void logger_log(LogLevel level, const char *file, int line, const char *fmt, ...);

// 快捷宏
#define LOG_ERR(fmt, ...)  logger_log(LOG_LEVEL_ERR,  __FILE__, __LINE__, fmt, ##__VA_ARGS__)
#define LOG_WARN(fmt, ...) logger_log(LOG_LEVEL_WARN, __FILE__, __LINE__, fmt, ##__VA_ARGS__)
#define LOG_INFO(fmt, ...) logger_log(LOG_LEVEL_INFO, __FILE__, __LINE__, fmt, ##__VA_ARGS__)
#define LOG_DBG(fmt, ...)  logger_log(LOG_LEVEL_DBG,  __FILE__, __LINE__, fmt, ##__VA_ARGS__)

// 彩色终端支持
#ifdef __linux__
    #define COLOR_RED     "\033[31m"
    #define COLOR_YELLOW  "\033[33m"
    #define COLOR_GREEN   "\033[32m"
    #define COLOR_BLUE    "\033[34m"
    #define COLOR_RESET   "\033[0m"
#else
    #define COLOR_RED     ""
    #define COLOR_YELLOW  ""
    #define COLOR_GREEN   ""
    #define COLOR_BLUE    ""
    #define COLOR_RESET   ""
#endif

#endif // LOGGER_H
```

```c
#include "logger.h"
#include <stdlib.h>

static FILE *log_output = NULL;
static LogLevel log_threshold = LOG_LEVEL_DBG; // 默认允许所有级别

// 初始化日志输出流
void logger_init(FILE *output) {
    log_output = output ? output : stderr;
}

// 获取日志级别字符串和颜色
static const char *get_level_info(LogLevel level, const char **color) {
    switch (level) {
        case LOG_LEVEL_ERR:  *color = COLOR_RED;    return "ERROR";
        case LOG_LEVEL_WARN: *color = COLOR_YELLOW; return "WARN";
        case LOG_LEVEL_INFO: *color = COLOR_GREEN;  return "INFO";
        case LOG_LEVEL_DBG:  *color = COLOR_BLUE;   return "DEBUG";
        default:             *color = COLOR_RESET;  return "UNKNOWN";
    }
}

// 核心日志实现
void logger_log(LogLevel level, const char *file, int line, const char *fmt, ...) {
    if (!log_output || level > log_threshold) return;

    // 时间戳
    time_t now = time(NULL);
    char timestamp[20];
    strftime(timestamp, sizeof(timestamp), "%Y-%m-%d %H:%M:%S", localtime(&now));

    // 日志级别信息
    const char *color = NULL;
    const char *level_str = get_level_info(level, &color);

    // 输出前缀
    fprintf(log_output, "%s[%s]%s %s:%d | ", 
            color, level_str, COLOR_RESET, 
            file, line);

    // 输出用户消息
    va_list args;
    va_start(args, fmt);
    vfprintf(log_output, fmt, args);
    va_end(args);

    // 确保换行
    fputc('\n', log_output);
    fflush(log_output); // 立即刷新缓冲区
}
```

```c
#include "logger.h"

int main() {
    // 初始化日志（输出到stderr）
    logger_init(stderr);

    LOG_ERR("Failed to open file: %s", "test.txt");  // 红色
    LOG_WARN("Connection timeout");                  // 黄色
    LOG_INFO("Server started on port %d", 8080);     // 绿色
    LOG_DBG("Debug value: %d", 42);                  // 蓝色

    return 0;
}
```

## 打印宏



结合每个

打印宏里面需要包括打印等级、主模块、子模块等信息

``` c

#define UPLOAD_DBG(...) PRINT_DEBUG(LEVEL_DBG ,PMODULE_TRAFFIC,PMODULE_TRAFFIC_UPLOAD,__VA_ARGS__); 
```

## 主模块与子模块


``` c
//模块主ID
typedef enum{
    PMODULE_TRAFFIC             = 0x0100,  /* 接收处理业务，数据接收，处理，上传业务 */
    PMODULE_DATA_MANAGE         = 0X0200,  /* 数据管理   ，数据库，图片处理业务 */
    PMODULE_SYSTEM				= 0x1100,  /* 系统功能，启动，DSP,  参数，看门狗，升级等 */
    PMODULE_NET					= 0x1300,  /* 网络相关，SDK,  NET,HTTPC, SADP,HTTP,FTP,RTSP, RTSPC.. */
    PMODULE_WEB					= 0x1400,  /* WEB相关，web配置 */
    PMODULE_PERIPHERAL			= 0x1500,  /* 外设相关，串口，音柱,GPS,面板.. */
    PMODULE_STORAGE				= 0x2200,  /* 存储相关 */
}ENUM_MODULE_MAJOR_NO;
```

