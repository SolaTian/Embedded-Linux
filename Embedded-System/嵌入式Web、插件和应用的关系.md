# 嵌入式 Web、插件和应用的关系

## 嵌入式应用

> 嵌入式应用：专门为嵌入式系统设计和开发的应用程序。运行在嵌入式设备的操作系统之上，借助硬件资源实现特定的功能。

手机也是一个嵌入式设备，其里面的应用程序，都是一个个的嵌入式应用程序。工业领域的嵌入式设备与手机不同的点在于，其上一般只能运行一个嵌入式应用程序。

### 前端后端分离

大多数嵌入式应用程序采用前端和后端分离的架构模式。之所以这样做的原因在于以下：

|嵌入式应用程序|前端|后端|
|-|-|-|
|模块化设计|负责用户界面 UI 和用户交互逻辑，通常运行在客户端（如网页浏览器、移动应用 app 界面或者专用终端设备）|负责业务逻辑、数据处理、与硬件交互以及存储管理，通过运行在嵌入式设备内部或者服务器端|
|功能分离|专注于用户交互和显示|专注于业务逻辑|
|用户界面需求|<li>web 界面（HTML/CSS/JavaScript）<li>移动应用界面（iOS/Android）<li>控制面板（如触摸屏）|负责为前端提供数据和接口（API），使前端能够动态展示和交互数据|
|分离硬件和业务逻辑|只需关注如何将数据可视化或暴露给用户，而不需要直接处理硬件复杂性|负责与硬件交互（如通过协议栈、驱动程序等），并将数据处理后提供给前端|
|安全性|前端用户只能通过后端提供的接口交互，而无法直接访问硬件或敏感数据|后端可以实施身份验证、访问控制（ACL）和数据加密等安全措施。|
|灵活性和扩展性|如果需要更新用户界面（前端），可以在不改变后端业务逻辑的情况下完成。|如果需要增加新的功能，可以通过后端扩展，而不会影响前端的运行。|
|Web接口的需求|<li>用户通过浏览器访问设备的 Web 界面（前端）。<li>Web 界面通过 HTTP/HTTPS 与后端交互（如RESTful API）。|后端处理用户的请求并返回数据。|


### 前后端交互流程举例

#### 手机查询天气应用

1. 用户启动 app，前端 UI 加载，显示主界面，自动或者用户输入城市名称
2. 前端通过 HTTP 协议向后端发送请求，比如下发一个 JSON，包括"city"和"weather"
3. 后端处理请求：后端接收到请求之后，解析参数"city"和"weather"
4. 后端调用 API，获取最新的天气数据，并将这个数据生成对应的 JSON 格式的响应
5. 后端通过 HTTP 响应将 JSON 数据返回给前端
6. 前端接收 JSON 数据后，解析后更新 UI，显示天气信息

#### 工业领域的嵌入式应用

工控机，用于监控生产设备的运行状态（如温度、压力、流速等），并允许操作员通过触摸屏或远程终端进行参数设置。

1. 工控机启动后，后端应用程序初始化，连接 PLC 或传感器。
2. 操作员打开界面，前端通过 RESTful API 或 WebSocket 向后端发送请求，要求获取实时数据。
3. 后端从 PLC 或传感器中读取实时数据（如温度、压力等），处理数据，生成 JSON 格式的响应。
4. 后端通过 HTTP 或 WebSocket 将数据发送给前端。
5. 前端解析 JSON 数据，更新 UI，显示实时数据。
6. 操作员在前端界面输入新的参数（如设置温度为55℃），前端将参数发送给后端。
7. 后端接收参数，验证后通过 Modbus 或其他协议将参数发送到 PLC 执行。
8. PLC 执行完操作后，通过后端将结果反馈给前端。


## 嵌入式应用前端实现方式之一——嵌入式 Web 服务器

上面介绍了嵌入式应用前端有多种实现方式，如 app 界面，web 界面，一些工业设备上的控制面板等。

可以说嵌入式应用的前端是一个比较宽泛的概念，包括但不限于

1. 图形界面：使用图形库或框架（如Qt、GTK+、LVGL）创建 GUI。
2. 文字界面：基于文本的交互界面，如命令行界面（CLI）。
3. Web界面：通过嵌入式 Web 服务器提供网页界面（HTML/CSS/JavaScript）。

> 嵌入式 web 服务器是一个小型的 HTTP 服务器，集成在嵌入式系统中，是嵌入式应用前端的一个具体实现方式。通过网页界面来实现前端功能，通过网络与客户端（如网页浏览器）交互。

嵌入式应用前端通过嵌入式 Web 服务器提供的接口（如 RESTful API）与后端逻辑通信，通信协议包括 HTTP/HTTPS，WebSocket 等。

### 常见的嵌入式 Web 服务器

|嵌入式 Web 服务器|说明|应用场景|
|-|-|-|
|Boa|<li>专为小型嵌入式系统设计<li>代码量非常小，内存占用极少，性能开销低，易于移植|如传感器节点、简单的智能家居控制器等|
|Mongoose|支持多种协议，包括 HTTP、WebSocket、MQTT 等，具有跨平台特性，可在 Linux、Windows、macOS 以及各种嵌入式操作系统上运行。|物联网设备、工业监控系统、家庭自动化等领域|
|Lighttpd|<li>安全、快速、兼容性好和低内存占用<li>支持 FastCGI、SCGI、Auth、输出压缩、URL 重写等丰富的功能模块，性能优越|对性能和功能要求较高的嵌入式设备,高端智能家居网关、企业级网络设备等|
|Nginx|<li>一款高性能的 HTTP 服务器和反向代理服务器，同时也提供了 IMAP/POP3/SMTP 代理服务<li>高并发处理能力、低内存消耗和强大的扩展性，支持异步 I/O 模型|大型嵌入式系统、网络边缘计算设备以及需要处理大量并发请求的场景中应用广泛|
|AppWeb|<li>在运行时所需的内存、存储等系统资源较少<li>采用了高效的事件驱动架构和多线程处理技术，能够快速响应客户端的请求，处理大量并发连接<li>提供了丰富的 API 和开发工具，方便集成到各种嵌入式应用程序中<li>安全可靠：支持多种安全机制，如 SSL/TLS 加密、用户认证、访问控制等<li>跨平台支持|广泛应用于工业自动化、智能家居、医疗设备、网络通信等领域|


### 以 AppWeb 为例的交互

AppWeb 支持多种方式与嵌入式应用后端进行交互。主要有以下几种交互方式：

|交互方式|说明|
|-|-|
|内置路由和回调函数|开发者将 URL 路径（如`/api/sensors`）映射到后端处理函数，例如<br>`appWebGet("/api/temperature", handleTemperatureRequest);`<br>流程为：<li>客户端发起请求<li>Appweb 解析请求<li>调用注册的后端处理函数<li>返回响应|
|RESTful API 接口|后端暴露 REST API（如`GET /api/status`），AppWeb将请求转发至后端并返回 JSON 响应|
|Web Socket 实时通信|用于实时数据推送（如设备状态更新），后端通过WebSocket主动发送数据到前端|
|CGI/FastCGI (较少使用)|外部程序调用，对资源要求较高，嵌入式场景中较少使用，但在某些系统中可能通过轻量级CGI执行脚本|


#### 页面切换

当切换到另一个静态页面时，比如一些网页的固定欢迎界面。

1. 客户端（浏览器）请求新的 URL（例如`GET /page2.html`）
2. AppWeb 根据路由配置找到对应的静态文件（若存在）
3. AppWeb直接返回 `page2.html` 文件内容给浏览器，不涉及后端业务逻辑。


当切换到另一个动态页面时，比如一些配置页面，这些页面的显示根据用户的配置会显示不同的内容，因此需要后端动态生成。

1. 客户端浏览器请求动态 URL（如`GET /dashboard`）
2. AppWeb 调用注册的后端处理函数（如`handleDashboardRequest`）
3. 后端生成 `HTML/XML`（或填充模板），AppWeb 作为 HTTP 服务器将内容返回给浏览器
4. 浏览器解析 `HTML/XML`并渲染成可视化页面


#### 页面保存

当用户在页面上点击保存的时候，交互流程如下：

1. 客户端浏览器发送`POST /save-config`请求或者 `PUT` 请求，并携带了保存的数据内容（格式可能是 `XML/HTML`或者表单等其他形式）
2. AppWeb 调用对应的后端处理函数（如`handleSaveConfig`）
3. 后端解析参数，执行业务逻辑（如保存配置到 Flash 或者一些全局变量中）
4. 后端返回重定向或 HTML 响应（如“保存成功”页面）

#### 页面新增显示或者逻辑配置项

当需要在已经有的页面上增加一个新的交互按钮实现新的逻辑功能时，这时 AppWeb 和后端都需要进行修改，因为要考虑到保存和正常显示。

先来看 AppWeb
1. 需要在

再来看后端
1. 实现一个新的逻辑函数
2. 注册新路由



