# 嵌入式 Web、插件和应用的关系

## 嵌入式应用

> 嵌入式应用：专门为嵌入式系统设计和开发的应用程序。运行在嵌入式设备的操作系统之上，借助硬件资源实现特定的功能。

手机也是一个嵌入式设备，其里面的应用程序，都是一个个的嵌入式应用程序。工业领域的嵌入式设备与手机不同的点在于，其上一般只能运行一个嵌入式应用程序。

### 前端后端分离

大多数嵌入式应用程序采用前端和后端分离的架构模式。之所以这样做的原因在于以下：

|嵌入式应用程序|前端|后端|
|-|-|-|
|模块化设计|负责用户界面 UI 和用户交互逻辑，通常运行在客户端（如网页浏览器、移动应用 app 界面或者专用终端设备）|负责业务逻辑、数据处理、与硬件交互以及存储管理，通过运行在嵌入式设备内部或者服务器端|
|功能分离|专注于用户交互和显示|专注于业务逻辑|
|用户界面需求|<li>web 界面（HTML/CSS/JavaScript）<li>移动应用界面（iOS/Android）<li>控制面板（如触摸屏）|负责为前端提供数据和接口（API），使前端能够动态展示和交互数据|
|分离硬件和业务逻辑|只需关注如何将数据可视化或暴露给用户，而不需要直接处理硬件复杂性|负责与硬件交互（如通过协议栈、驱动程序等），并将数据处理后提供给前端|
|安全性|前端用户只能通过后端提供的接口交互，而无法直接访问硬件或敏感数据|后端可以实施身份验证、访问控制（ACL）和数据加密等安全措施。|
|灵活性和扩展性|如果需要更新用户界面（前端），可以在不改变后端业务逻辑的情况下完成。|如果需要增加新的功能，可以通过后端扩展，而不会影响前端的运行。|
|Web接口的需求|<li>用户通过浏览器访问设备的 Web 界面（前端）。<li>Web 界面通过 HTTP/HTTPS 与后端交互（如RESTful API）。|后端处理用户的请求并返回数据。|


### 前后端交互流程举例

#### 手机查询天气应用

1. 用户启动 app，前端 UI 加载，显示主界面，自动或者用户输入城市名称
2. 前端通过 HTTP 协议向后端发送请求，比如下发一个 JSON，包括"city"和"weather"
3. 后端处理请求：后端接收到请求之后，解析参数"city"和"weather"
4. 后端调用 API，获取最新的天气数据，并将这个数据生成对应的 JSON 格式的响应
5. 后端通过 HTTP 响应将 JSON 数据返回给前端
6. 前端接收 JSON 数据后，解析后更新 UI，显示天气信息

#### 工业领域的嵌入式应用

工控机，用于监控生产设备的运行状态（如温度、压力、流速等），并允许操作员通过触摸屏或远程终端进行参数设置。

1. 工控机启动后，后端应用程序初始化，连接 PLC 或传感器。
2. 操作员打开界面，前端通过 RESTful API 或 WebSocket 向后端发送请求，要求获取实时数据。
3. 后端从 PLC 或传感器中读取实时数据（如温度、压力等），处理数据，生成 JSON 格式的响应。
4. 后端通过 HTTP 或 WebSocket 将数据发送给前端。
5. 前端解析 JSON 数据，更新 UI，显示实时数据。
6. 操作员在前端界面输入新的参数（如设置温度为55℃），前端将参数发送给后端。
7. 后端接收参数，验证后通过 Modbus 或其他协议将参数发送到 PLC 执行。
8. PLC 执行完操作后，通过后端将结果反馈给前端。


## 嵌入式应用前端实现方式之一——嵌入式 Web 服务器

上面介绍了嵌入式应用前端有多种实现方式，如 app 界面，web 界面，一些工业设备上的控制面板等。

可以说嵌入式应用的前端是一个比较宽泛的概念，包括但不限于

1. 图形界面：使用图形库或框架（如Qt、GTK+、LVGL）创建 GUI。
2. 文字界面：基于文本的交互界面，如命令行界面（CLI）。
3. Web界面：通过嵌入式 Web 服务器提供网页界面（HTML/CSS/JavaScript）。

> 嵌入式 web 服务器是一个小型的 HTTP 服务器，集成在嵌入式系统中，是嵌入式应用前端的一个具体实现方式。通过网页界面来实现前端功能，通过网络与客户端（如网页浏览器）交互。

嵌入式应用前端通过嵌入式 Web 服务器提供的接口（如 RESTful API）与后端逻辑通信，通信协议包括 HTTP/HTTPS，WebSocket 等。

### 嵌入式 Web 服务器、浏览器、后端 三者的关系
|组件|定位|职责|
|-|-|-|
|嵌入式后端|处理业务逻辑的核心部分，通常运行在嵌入式设备上|<li>接收浏览器通过Web服务器转发的请求（如保存数据、控制硬件）<li>执行实际业务逻辑（如数据存储、设备状态读写、传感器数据处理）<li>与硬件或操作系统交互（如通过GPIO控制外设）|
|嵌入式 Web 服务器|连接浏览器（前端）与嵌入式后端的中介，属于嵌入式设备|<li>接收并解析浏览器的HTTP请求<li>将请求转发给嵌入式后端处理（如调用后端函数）<li>将后端返回的结果封装为HTTP响应，返回给浏览器|
|客户端浏览器（前端）|用户与嵌入式系统交互的前端界面，属于用户设备|<li>渲染用户界面（`HTML/CSS/JS`）<li>向嵌入式 Web 服务器发送 HTTP 请求（`GET/POST/PUT`）<li>接收并展示服务器返回的响应（页面、数据或错误信息）|


### 常见的嵌入式 Web 服务器

|嵌入式 Web 服务器|说明|应用场景|
|-|-|-|
|Boa|<li>专为小型嵌入式系统设计<li>代码量非常小，内存占用极少，性能开销低，易于移植|如传感器节点、简单的智能家居控制器等|
|Mongoose|支持多种协议，包括 HTTP、WebSocket、MQTT 等，具有跨平台特性，可在 Linux、Windows、macOS 以及各种嵌入式操作系统上运行。|物联网设备、工业监控系统、家庭自动化等领域|
|Lighttpd|<li>安全、快速、兼容性好和低内存占用<li>支持 FastCGI、SCGI、Auth、输出压缩、URL 重写等丰富的功能模块，性能优越|对性能和功能要求较高的嵌入式设备,高端智能家居网关、企业级网络设备等|
|Nginx|<li>一款高性能的 HTTP 服务器和反向代理服务器，同时也提供了 IMAP/POP3/SMTP 代理服务<li>高并发处理能力、低内存消耗和强大的扩展性，支持异步 I/O 模型|大型嵌入式系统、网络边缘计算设备以及需要处理大量并发请求的场景中应用广泛|
|AppWeb|<li>在运行时所需的内存、存储等系统资源较少<li>采用了高效的事件驱动架构和多线程处理技术，能够快速响应客户端的请求，处理大量并发连接<li>提供了丰富的 API 和开发工具，方便集成到各种嵌入式应用程序中<li>安全可靠：支持多种安全机制，如 SSL/TLS 加密、用户认证、访问控制等<li>跨平台支持|广泛应用于工业自动化、智能家居、医疗设备、网络通信等领域|


### 以 AppWeb 为例的交互

AppWeb 支持多种方式与嵌入式应用后端进行交互。主要有以下几种交互方式：

|交互方式|说明|
|-|-|
|内置路由和回调函数|开发者将 URL 路径（如`/api/sensors`）映射到后端处理函数，例如<br>`appWebGet("/api/temperature", handleTemperatureRequest);`<br>流程为：<li>客户端发起请求<li>Appweb 解析请求<li>调用注册的后端处理函数<li>返回响应|
|RESTful API 接口|后端暴露 REST API（如`GET /api/status`），AppWeb将请求转发至后端并返回 JSON 响应|
|Web Socket 实时通信|用于实时数据推送（如设备状态更新），后端通过WebSocket主动发送数据到前端|
|CGI/FastCGI (较少使用)|外部程序调用，对资源要求较高，嵌入式场景中较少使用，但在某些系统中可能通过轻量级CGI执行脚本|


#### 页面切换

当切换到另一个静态页面时，比如一些网页的固定欢迎界面。

1. 客户端（浏览器）请求新的 URL（例如`GET /page2.html`）
2. AppWeb 根据路由配置找到对应的静态文件（若存在）
3. AppWeb直接返回 `page2.html` 文件内容给浏览器，不涉及后端业务逻辑。


当切换到另一个动态页面时，比如一些配置页面，这些页面的显示根据用户的配置会显示不同的内容，因此需要后端动态生成。

1. 客户端浏览器请求动态 URL（如`GET /dashboard`）
2. AppWeb 调用注册的后端处理函数（如`handleDashboardRequest`）
3. 后端生成 `HTML/XML`（或填充模板），AppWeb 作为 HTTP 服务器将内容返回给浏览器
4. 浏览器解析 `HTML/XML`并渲染成可视化页面


#### 页面保存

当用户在页面上点击保存的时候，交互流程如下：

1. 客户端浏览器发送`POST /save-config`请求或者 `PUT` 请求，并携带了保存的数据内容（格式可能是 `XML/HTML`或者表单等其他形式）
2. AppWeb 调用对应的后端处理函数（如`handleSaveConfig`）
3. 后端解析参数，执行业务逻辑（如保存配置到 Flash 或者一些全局变量中）
4. 后端返回重定向或 HTML 响应（如“保存成功”页面）



#### F12 浏览器开发者工具

在 Web 开发时，常常会用到 F12 开发者工具，**可以用来捕获浏览器与嵌入式 Web 服务器之间的交互**

常见的有以下几种交互

1. 页面切换（触发`GET`请求）
2. 点击保存（触发`POST/PUT`请求）


### Web 资源组与 AppWeb

在嵌入式软件这个行业中，一般都有 Web 资源组与应用软件组，但是其实嵌入式 Web 服务器（AppWeb）的初始化和一些路由回调都是在应用的代码逻辑中。到这里就有一个疑问。

**为什么 Web 资源组不负责 AppWeb，而要由应用软件组来负责 AppWeb 呢？**

有以下几点原因：

|现象|应用软件组|Web 资源组|
|-|-|-|
|AppWeb 初始化在应用组代码中|Web 服务器（如 Appweb）的启动和配置需要与业务逻辑紧密结合。例如：<li>绑定特定端口、设置安全策略。<li>注册路由与后端回调函数的关联（如将`/api/led`映射到`handle_led_request() `）|可能提供静态资源路径（Web 资源组打包）或前端路由规则，但不直接操作 Web 服务器的初始化|
|路由回调在应用组代码中实现|路由回调（如`/api/save`对应的处理函数）本质属于业务逻辑，需要操作硬件、访问数据或执行业务规则，因此由应用组实现|可能定义路由的前端调用方式（例如通过 JavaScript 发起 `POST` 请求到 `/api/save`），但不关心后端如何处理。|


**Web资源组关注“用户看到什么”，应用组关注“数据如何处理”。**

Web 资源组可能具体负责以下几个方面内容：
1. 前端页面开发
   1. 编写 `HTML/CSS/JavaScript` 代码，设计用户界面。
   2. 确保页面适配嵌入式设备的显示限制（如小屏幕、低分辨率）
2. 与后端接口协商
   1. 确定API格式（如RESTful接口、请求参数、响应数据结构）
   2. 提供Mock数据供前端独立调试
3. 性能优化
   1. 减少前端资源占用的存储空间（关键约束在嵌入式设备中）。
   2. 优化网络请求（如减少请求次数、使用缓存）。

#### Web 资源组和应用组典型合作流程

以“设备配置页面”开发为例：

1. Web资源组：
   1. 开发配置页面的 `HTML` 表单和`JavaScript`交互逻辑。
   2. 定义表单提交的 API 端点（如`POST /api/config`）。
2. 应用组:
   1. 在 Appweb 中注册路由`/api/config`，并实现回调函数`handle_config_request()`，解析表单数据、更新设备配置。
   2. 初始化 Web 服务器，配置静态资源路径（指向 Web 资源组提供的 HTML/JS 文件），一般这个就是将 Web 资源组修改后的`HTML/JS/CSS`文件打包到嵌入式设备的文件系统中，并确保 Appweb 配置的静态资源目录指向最新文件。
3. 联调：
   1. Web 资源组通过浏览器访问嵌入式设备，测试页面渲染和 API 调用
   2. 应用组验证后端逻辑是否正确处理请求。

#### 页面新增显示或者逻辑配置项

当需要在已经有的页面上增加一个新的交互按钮实现新的逻辑功能时，这时除了原先客户端浏览器与 AppWeb 的交互，还涉及到 Web 端的修改，同时应用后端也需要进行修改，因为要考虑到保存和正常显示。

先来看 Web 端
- 需要增加新显示栏的 UI 元素，定义数据获取与保存的交互逻辑
  - 使用`HTML/CSS`新增显示栏
  - 使用`JavaScript`发起数据请求与保存
  - 确保切换页面时新显示栏的数据能够正常加载

再来看应用后端
- 新增数据读取接口
- 扩展或新增保存接口
- 实现`read_embedded_sensor()`和`save_to_device()`，这些函数可能需要调用底层硬件驱动或通过IPC与嵌入式后端通信

最后看 AppWeb
- 注册新路由（或者复用已经有的路由）
- 更新更新静态资源路径：将 Web 资源组修改后的`HTML/JS/CSS`文件打包到嵌入式设备的文件系统中，并确保 AppWeb 配置的静态资源目录指向最新文件


应用后端和 AppWeb 的工作都由应用软件组来完成。

## 什么是插件

### 插件与应用的关系

### 插件与 Web 的关系